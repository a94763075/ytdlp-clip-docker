<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube ç‰‡æ®µåˆ‡å‰²</title>
  <style>
    /* åŸºç¤é‡ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* å…¨å±€æ¨£å¼ */
    :root {
      --bg-gradient-light: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --bg-gradient-dark: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      --card-bg-light: rgba(255, 255, 255, 0.95);
      --card-bg-dark: rgba(15, 23, 42, 0.95);
      --text-color-light: #2c3e50;
      --text-color-dark: #e2e8f0;
      --border-color-light: rgba(255, 255, 255, 0.2);
      --border-color-dark: rgba(255, 255, 255, 0.1);
      --input-border-light: #e5e7eb;
      --input-border-dark: #334155;
      --input-bg-light: rgba(255, 255, 255, 0.8);
      --input-bg-dark: rgba(30, 41, 59, 0.8);
      --primary-color: #3b82f6;
      --primary-dark: #2563eb;
      --primary-darker: #1d4ed8;
      --accent-gradient: linear-gradient(90deg, #3b82f6, #60a5fa);
      --button-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      --card-shadow-dark: 0 10px 30px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }

    body {
      font-family: 'Noto Sans TC', 'Segoe UI', sans-serif;
      background: var(--bg-gradient-light);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      color: var(--text-color-light);
      transition: var(--transition);
    }

    body.dark-mode {
      background: var(--bg-gradient-dark);
      color: var(--text-color-dark);
    }

    /* è¡¨å–®å®¹å™¨ */
    .form-container {
      background-color: var(--card-bg-light);
      padding: 35px 40px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 520px;
      margin-bottom: 25px;
      transition: var(--transition);
      border: 1px solid var(--border-color-light);
      backdrop-filter: blur(5px);
    }

    .dark-mode .form-container {
      background-color: var(--card-bg-dark);
      box-shadow: var(--card-shadow-dark);
      border: 1px solid var(--border-color-dark);
    }

    .form-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .dark-mode .form-container:hover {
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
    }

    /* æ¨™é¡Œ */
    h1 {
      color: #1e3a8a;
      text-align: center;
      margin-bottom: 30px;
      font-size: 32px;
      font-weight: 700;
      position: relative;
      padding-bottom: 12px;
    }

    .dark-mode h1 {
      color: #60a5fa;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: var(--accent-gradient);
      border-radius: 2px;
    }

    /* è¡¨å–®çµ„ */
    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    /* æ¨™ç±¤ */
    label {
      display: block;
      color: #4b5563;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 15px;
      transition: color 0.3s ease;
    }

    .dark-mode label {
      color: #94a3b8;
    }

    .form-group:focus-within label {
      color: #2563eb;
    }

    .dark-mode .form-group:focus-within label {
      color: #60a5fa;
    }

    /* è¼¸å…¥æ¡† */
    input[type="text"],
    input[name="video_url"],
    input[name="start_time"],
    input[name="end_time"] {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--input-border-light);
      border-radius: 10px;
      font-size: 16px;
      color: #374151;
      transition: var(--transition);
      background-color: var(--input-bg-light);
    }

    .dark-mode input[type="text"],
    .dark-mode input[name="video_url"],
    .dark-mode input[name="start_time"],
    .dark-mode input[name="end_time"] {
      border-color: var(--input-border-dark);
      background-color: var(--input-bg-dark);
      color: #e2e8f0;
    }

    input[type="text"]:focus,
    input[name="video_url"]:focus,
    input[name="start_time"]:focus,
    input[name="end_time"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
      outline: none;
      background-color: #fff;
    }

    .dark-mode input[type="text"]:focus,
    .dark-mode input[name="video_url"]:focus,
    .dark-mode input[name="start_time"]:focus,
    .dark-mode input[name="end_time"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
      background-color: rgba(30, 41, 59, 0.95);
    }

    input::placeholder {
      color: #9ca3af;
      font-size: 14px;
    }

    .dark-mode input::placeholder {
      color: #64748b;
    }

    /* åœ–ç¤º */
    .form-group::before {
      position: absolute;
      right: 15px;
      top: 42px;
      font-family: Arial, sans-serif;
      font-size: 18px;
      color: #9ca3af;
      pointer-events: none;
    }

    .dark-mode .form-group::before {
      color: #64748b;
    }

    .form-group:nth-of-type(1)::before {
      content: 'ğŸ”—';
    }

    .form-group:nth-of-type(2)::before {
      content: 'â±ï¸';
    }

    .form-group:nth-of-type(3)::before {
      content: 'â±ï¸';
    }

    /* æŒ‰éˆ• */
    button[type="submit"], 
    .btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 17px;
      font-weight: 600;
      width: 100%;
      transition: var(--transition);
      margin-top: 10px;
      letter-spacing: 0.5px;
      box-shadow: var(--button-shadow);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      margin-top: 10px;
    }

    button[type="submit"]:hover:not(:disabled),
    .btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      box-shadow: 0 6px 15px rgba(37, 99, 235, 0.4);
      transform: translateY(-2px);
    }

    .btn-secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #475569 0%, #334155 100%);
      box-shadow: 0 6px 15px rgba(71, 85, 105, 0.4);
    }

    button[type="submit"]:active:not(:disabled),
    .btn:active:not(:disabled) {
      transform: scale(0.98) translateY(0);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }
    
    button[type="submit"]:disabled,
    .btn:disabled {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* æµ®å‹•æ“ä½œæŒ‰éˆ• */
    .floating-actions {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }

    .float-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: var(--transition);
      border: none;
      font-size: 20px;
    }

    .float-btn:hover {
      transform: translateY(-3px) scale(1.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.25);
    }

    /* ç‹€æ…‹æ¶ˆæ¯å€åŸŸ */
    #statusMessage {
      margin-top: 5px;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      width: 100%;
      max-width: 520px;
      font-weight: 500;
      position: relative;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: var(--transition);
    }

    .dark-mode #statusMessage {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #statusMessage.success {
      background-color: #ecfdf5;
      color: #065f46;
      border-left: 5px solid #10b981;
    }

    .dark-mode #statusMessage.success {
      background-color: rgba(6, 95, 70, 0.2);
      color: #34d399;
      border-left: 5px solid #10b981;
    }

    #statusMessage.error {
      background-color: #fef2f2;
      color: #991b1b;
      border-left: 5px solid #ef4444;
    }

    .dark-mode #statusMessage.error {
      background-color: rgba(153, 27, 27, 0.2);
      color: #f87171;
      border-left: 5px solid #ef4444;
    }

    #statusMessage.info {
      background-color: #eff6ff;
      color: #1e40af;
      border-left: 5px solid #3b82f6;
    }

    .dark-mode #statusMessage.info {
      background-color: rgba(30, 64, 175, 0.2);
      color: #60a5fa;
      border-left: 5px solid #3b82f6;
    }

    #statusMessage a {
      display: inline-block;
      margin-top: 12px;
      font-weight: 600;
      color: #2563eb;
      text-decoration: none;
      background-color: #e0f2fe;
      padding: 10px 18px;
      border-radius: 8px;
      transition: var(--transition);
    }

    .dark-mode #statusMessage a {
      color: #60a5fa;
      background-color: rgba(224, 242, 254, 0.15);
    }

    #statusMessage a:hover {
      background-color: #bfdbfe;
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .dark-mode #statusMessage a:hover {
      background-color: rgba(191, 219, 254, 0.25);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }

    /* é€²åº¦æ¢ */
    .progress-container {
      width: 100%;
      background-color: #e5e7eb;
      height: 10px;
      border-radius: 5px;
      margin-top: 15px;
      overflow: hidden;
    }

    .dark-mode .progress-container {
      background-color: #334155;
    }

    .progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    /* é è¦½èˆ‡è¨ˆæ™‚é¡¯ç¤º */
    .preview-container {
      margin-top: 20px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #videoPreview {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      display: none;
      max-height: 240px;
      object-fit: contain;
      background-color: #000;
    }

    .dark-mode #videoPreview {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .time-info {
      margin-top: 10px;
      font-size: 14px;
      color: #4b5563;
      padding: 8px 12px;
      background-color: #f9fafb;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dark-mode .time-info {
      color: #94a3b8;
      background-color: #1e293b;
    }

    .time-info span {
      font-weight: 600;
      color: #2563eb;
    }

    .dark-mode .time-info span {
      color: #60a5fa;
    }

    /* æ­·å²è¨˜éŒ„é¢æ¿ */
    .history-panel {
      position: fixed;
      right: -350px;
      top: 0;
      width: 350px;
      height: 100vh;
      background-color: white;
      box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15);
      transition: right 0.4s ease;
      z-index: 1000;
      overflow-y: auto;
      padding: 25px;
    }

    .dark-mode .history-panel {
      background-color: #0f172a;
      box-shadow: -5px 0 25px rgba(0, 0, 0, 0.35);
    }

    .history-panel.open {
      right: 0;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .dark-mode .history-header {
      border-bottom: 1px solid #334155;
    }

    .history-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e3a8a;
    }

    .dark-mode .history-header h2 {
      color: #60a5fa;
    }

    .close-history {
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      transition: var(--transition);
    }

    .dark-mode .close-history {
      color: #94a3b8;
    }

    .close-history:hover {
      color: #ef4444;
      transform: scale(1.1);
    }

    .history-items {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .history-item {
      background-color: #f9fafb;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: var(--transition);
    }

    .dark-mode .history-item {
      background-color: #1e293b;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }

    .history-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .dark-mode .history-item:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
    }

    .history-item h3 {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1e3a8a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dark-mode .history-item h3 {
      color: #60a5fa;
    }

    .history-meta {
      font-size: 0.85rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
    }

    .dark-mode .history-meta {
      color: #94a3b8;
    }

    .history-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
    }

    .history-btn {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      background-color: #eff6ff;
      color: #2563eb;
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .dark-mode .history-btn {
      background-color: rgba(239, 246, 255, 0.1);
      color: #60a5fa;
    }

    .history-btn:hover {
      background-color: #dbeafe;
      transform: translateY(-2px);
    }

    .dark-mode .history-btn:hover {
      background-color: rgba(219, 234, 254, 0.2);
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    .overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    /* Tool æç¤º */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 140px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -70px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      font-weight: normal;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    .dark-mode .tooltip .tooltiptext {
      background-color: #1e293b;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.35);
    }

    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
    }

    .dark-mode .tooltip .tooltiptext::after {
      border-color: #1e293b transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Format validation feedback */
    .format-feedback {
      margin-top: 5px;
      font-size: 12px;
      color: #9ca3af;
      transition: var(--transition);
    }

    .dark-mode .format-feedback {
      color: #64748b;
    }

    .format-valid {
      color: #10b981;
    }

    .dark-mode .format-valid {
      color: #34d399;
    }

    .format-invalid {
      color: #ef4444;
    }

    .dark-mode .format-invalid {
      color: #f87171;
    }

    /* Logoå‹•ç•« */
    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
    }

    .logo span {
      position: relative;
      background: -webkit-linear-gradient(45deg, #3b82f6, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 45px;
      margin-right: 10px;
      animation: pulse 2s infinite;
    }

    /* å‹•ç•«æ•ˆæœ */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 600px) {
      .form-container {
        padding: 25px 20px;
        max-width: 100%;
      }
      
      h1 {
        font-size: 24px;
      }
      
      input[type="text"],
      input[name="video_url"],
      input[name="start_time"],
      input[name="end_time"],
      button[type="submit"] {
        padding: 12px 14px;
        font-size: 15px;
      }
      
      #statusMessage {
        padding: 12px;
        max-width: 100%;
      }
      
      .form-group::before {
        top: 38px;
        font-size: 16px;
      }

      .history-panel {
        width: 100%;
        right: -100%;
      }
    }
  </style>
</head>
<body>
  <div class="logo">
    <span>âœ‚ï¸</span>
  </div>
  <div class="form-container">
    <h1>YouTube ç‰‡æ®µåˆ‡å‰²</h1>
    <form id="clipForm">
      <div class="form-group">
        <label for="video_url">å½±ç‰‡ç¶²å€ (URL)</label>
        <input type="text" id="video_url" name="video_url" required value="https://www.youtube.com/watch?v=-wiI0DwP5bY" placeholder="è²¼ä¸Š YouTube å½±ç‰‡é€£çµ">
        <div id="urlFeedback" class="format-feedback"></div>
      </div>
      <div class="form-group">
        <label for="start_time">é–‹å§‹æ™‚é–“ (Start)</label>
        <input type="text" id="start_time" name="start_time" placeholder="ä¾‹å¦‚: 01:25 æˆ– 01:25:30" required value="18:35">
        <div id="startFeedback" class="format-feedback"></div>
      </div>
      <div class="form-group">
        <label for="end_time">çµæŸæ™‚é–“ (End)</label>
        <input type="text" id="end_time" name="end_time" placeholder="ä¾‹å¦‚: 01:35 æˆ– 01:35:45" required value="18:40">
        <div id="endFeedback" class="format-feedback"></div>
      </div>
      <div class="time-info">
        é è¨ˆåˆ‡å‰²æ™‚é•·: <span id="clipDuration">00:05</span>
      </div>

      <div class="preview-container">
        <button type="button" id="previewBtn" class="btn btn-secondary">é è¦½å½±ç‰‡</button>
        <video id="videoPreview" controls></video>
      </div>

      <button type="submit" id="submitButton">é–‹å§‹åˆ‡ç‰‡</button>
    </form>
  </div>
  <div id="statusMessage"></div>

  <!-- æ­·å²è¨˜éŒ„ -->
  <div class="history-panel" id="historyPanel">
    <div class="history-header">
      <h2>å‰ªè¼¯æ­·å²</h2>
      <button class="close-history" id="closeHistory">Ã—</button>
    </div>
    <div class="history-items" id="historyItems">
      <!-- æ­·å²è¨˜éŒ„é …ç›®æœƒåœ¨é€™è£¡å‹•æ…‹æ·»åŠ  -->
    </div>
  </div>

  <!-- èƒŒæ™¯è¦†è“‹å±¤ -->
  <div class="overlay" id="overlay"></div>

  <!-- æµ®å‹•æŒ‰éˆ• -->
  <div class="floating-actions">
    <button class="float-btn tooltip" id="darkModeToggle" aria-label="åˆ‡æ›æ·±è‰²æ¨¡å¼">
      ğŸŒ™
      <span class="tooltiptext">åˆ‡æ›æ·±è‰²æ¨¡å¼</span>
    </button>
    <button class="float-btn tooltip" id="historyBtn" aria-label="æŸ¥çœ‹æ­·å²">
      ğŸ“‹
      <span class="tooltiptext">æŸ¥çœ‹æ­·å²</span>
    </button>
  </div>

  <script>
    // DOMå…ƒç´ 
    const clipForm = document.getElementById('clipForm');
    const submitButton = document.getElementById('submitButton');
    const statusMessageDiv = document.getElementById('statusMessage');
    const videoUrlInput = document.getElementById('video_url');
    const startTimeInput = document.getElementById('start_time');
    const endTimeInput = document.getElementById('end_time');
    const clipDurationSpan = document.getElementById('clipDuration');
    const previewBtn = document.getElementById('previewBtn');
    const videoPreview = document.getElementById('videoPreview');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const historyBtn = document.getElementById('historyBtn');
    const historyPanel = document.getElementById('historyPanel');
    const closeHistory = document.getElementById('closeHistory');
    const overlay = document.getElementById('overlay');
    const historyItems = document.getElementById('historyItems');
    const urlFeedback = document.getElementById('urlFeedback');
    const startFeedback = document.getElementById('startFeedback');
    const endFeedback = document.getElementById('endFeedback');

    let jobPollingInterval = null;
    let processingProgress = 0;
    let progressInterval = null;
    let history = JSON.parse(localStorage.getItem('clipHistory') || '[]');

    // åˆå§‹åŒ–é é¢
    function init() {
      loadDarkModePreference();
      renderHistory();
      updateClipDuration();

      // è¨­ç½®äº‹ä»¶ç›£è½å™¨
      clipForm.addEventListener('submit', handleFormSubmit);
      previewBtn.addEventListener('click', togglePreview);
      darkModeToggle.addEventListener('click', toggleDarkMode);
      historyBtn.addEventListener('click', toggleHistoryPanel);
      closeHistory.addEventListener('click', closeHistoryPanel);
      overlay.addEventListener('click', closeHistoryPanel);

      // æ™‚é–“è¼¸å…¥è‡ªå‹•æ ¼å¼åŒ–å’Œé©—è­‰
      startTimeInput.addEventListener('input', handleTimeInput);
      endTimeInput.addEventListener('input', handleTimeInput);
      startTimeInput.addEventListener('blur', formatTimeInput);
      endTimeInput.addEventListener('blur', formatTimeInput);

      // è¨ˆç®—åˆ‡å‰²æ™‚é•·
      startTimeInput.addEventListener('input', updateClipDuration);
      endTimeInput.addEventListener('input', updateClipDuration);

      // URLé©—è­‰
      videoUrlInput.addEventListener('input', validateYoutubeUrl);
      videoUrlInput.addEventListener('blur', validateYoutubeUrl);
    }

    // è¡¨å–®æäº¤è™•ç†
    async function handleFormSubmit(e) {
      e.preventDefault();
      const payload = {
        video_url: videoUrlInput.value.trim(),
        start_time: startTimeInput.value.trim(),
        end_time: endTimeInput.value.trim()
      };
      
      if (!validateForm()) {
        return;
      }
      
      submitButton.disabled = true;
      updateStatus('æ­£åœ¨æäº¤è«‹æ±‚ï¼Œè«‹ç¨å€™...', 'info');

      try {
        // æ¨¡æ“¬é€²åº¦æ›´æ–°
        startProgressSimulation();

        const res = await fetch('/submit_job', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'æäº¤å¤±æ•—');

        updateStatus(data.message || 'æ­£åœ¨è™•ç†æ‚¨çš„å½±ç‰‡...', 'info');
        
        // æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
        addToHistory(payload, data.job_id);
        
        // é–‹å§‹è¼ªè©¢å·¥ä½œç‹€æ…‹
        pollJobStatus(data.job_id);
      } catch (err) {
        clearInterval(progressInterval);
        updateStatus('æäº¤å¤±æ•—ï¼š' + err.message, 'error');
        submitButton.disabled = false;
      }
    }

    // è¡¨å–®é©—è­‰
    function validateForm() {
      let isValid = true;
      
      // é©—è­‰URL
      if (!validateYoutubeUrl()) {
        isValid = false;
      }
      
      // é©—è­‰æ™‚é–“æ ¼å¼
      if (!validateTimeFormat(startTimeInput.value)) {
        startFeedback.textContent = 'æ™‚é–“æ ¼å¼ç„¡æ•ˆï¼Œè«‹ä½¿ç”¨ mm:ss æˆ– hh:mm:ss æ ¼å¼';
        startFeedback.className = 'format-feedback format-invalid';
        isValid = false;
      }
      
      if (!validateTimeFormat(endTimeInput.value)) {
        endFeedback.textContent = 'æ™‚é–“æ ¼å¼ç„¡æ•ˆï¼Œè«‹ä½¿ç”¨ mm:ss æˆ– hh:mm:ss æ ¼å¼';
        endFeedback.className = 'format-feedback format-invalid';
        isValid = false;
      }
      
      // é©—è­‰æ™‚é–“é †åº
      if (isValid && compareTimestamps(startTimeInput.value, endTimeInput.value) >= 0) {
        endFeedback.textContent = 'çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“';
        endFeedback.className = 'format-feedback format-invalid';
        isValid = false;
      }
      
      return isValid;
    }

    // Youtube URL é©—è­‰
    function validateYoutubeUrl() {
      const url = videoUrlInput.value.trim();
      const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      
      if (!url) {
        urlFeedback.textContent = 'è«‹è¼¸å…¥ YouTube ç¶²å€';
        urlFeedback.className = 'format-feedback format-invalid';
        return false;
      }
      
      if (!youtubeRegex.test(url)) {
        urlFeedback.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ YouTube å½±ç‰‡ç¶²å€';
        urlFeedback.className = 'format-feedback format-invalid';
        return false;
      }
      
      urlFeedback.textContent = 'ç¶²å€æ ¼å¼æœ‰æ•ˆ';
      urlFeedback.className = 'format-feedback format-valid';
      return true;
    }

    // æ™‚é–“æ ¼å¼é©—è­‰å’Œè™•ç†
    function handleTimeInput(e) {
      const input = e.target;
      const feedbackEl = input.id === 'start_time' ? startFeedback : endFeedback;
      
      // å…è¨±è¼¸å…¥æ•¸å­—ã€å†’è™Ÿå’Œé€€æ ¼éµ
      const val = input.value;
      
      if (val.length === 0) {
        feedbackEl.textContent = '';
        feedbackEl.className = 'format-feedback';
        return;
      }
      
      if (validateTimeFormat(val)) {
        feedbackEl.textContent = 'æ™‚é–“æ ¼å¼æœ‰æ•ˆ';
        feedbackEl.className = 'format-feedback format-valid';
      } else {
        feedbackEl.textContent = 'è«‹ä½¿ç”¨ mm:ss æˆ– hh:mm:ss æ ¼å¼';
        feedbackEl.className = 'format-feedback';
      }
    }

    // æ ¼å¼åŒ–æ™‚é–“è¼¸å…¥
    function formatTimeInput(e) {
      const input = e.target;
      const val = input.value.trim();
      
      if (!val) return;
      
      // å˜—è©¦å°‡è¼¸å…¥æ ¼å¼åŒ–ç‚ºæœ‰æ•ˆçš„æ™‚é–“æ ¼å¼
      const timeRegex = /^(\d+):(\d+)(?::(\d+))?$/;
      const match = val.match(timeRegex);
      
      if (match) {
        let hours = 0, minutes = 0, seconds = 0;
        
        if (match[3]) { // hh:mm:ss æ ¼å¼
          hours = parseInt(match[1]);
          minutes = parseInt(match[2]);
          seconds = parseInt(match[3]);
        } else { // mm:ss æ ¼å¼
          minutes = parseInt(match[1]);
          seconds = parseInt(match[2]);
        }
        
        // æ¨™æº–åŒ–æ™‚é–“å€¼ (è™•ç†æº¢å‡º)
        minutes += Math.floor(seconds / 60);
        seconds %= 60;
        hours += Math.floor(minutes / 60);
        minutes %= 60;
        
        // æ ¼å¼åŒ–è¼¸å‡º
        if (hours > 0) {
          input.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else {
          input.value = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
      }
      
      validateTimeFormat(input.value);
      updateClipDuration();
    }

    // é©—è­‰æ™‚é–“æ ¼å¼
    function validateTimeFormat(timeStr) {
      const timeRegex = /^(?:(?:([01]?\d|2[0-3]):)?([0-5]?\d):)?([0-5]?\d)$/;
      return timeRegex.test(timeStr);
    }

    // è¨ˆç®—æ™‚é–“æˆ³çš„ç§’æ•¸
    function timestampToSeconds(timestamp) {
      const parts = timestamp.split(':').map(Number);
      let seconds = 0;
      
      if (parts.length === 3) { // hh:mm:ss
        seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
      } else if (parts.length === 2) { // mm:ss
        seconds = parts[0] * 60 + parts[1];
      }
      
      return seconds;
    }

    // æ¯”è¼ƒå…©å€‹æ™‚é–“æˆ³
    function compareTimestamps(start, end) {
      return timestampToSeconds(start) - timestampToSeconds(end);
    }

    // ç§’æ•¸è½‰æ›ç‚ºæ™‚é–“æ ¼å¼
    function secondsToTimestamp(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // æ›´æ–°å‰ªè¼¯æ™‚é•·é¡¯ç¤º
    function updateClipDuration() {
      const startTime = startTimeInput.value.trim();
      const endTime = endTimeInput.value.trim();
      
      if (validateTimeFormat(startTime) && validateTimeFormat(endTime)) {
        const startSeconds = timestampToSeconds(startTime);
        const endSeconds = timestampToSeconds(endTime);
        
        if (endSeconds > startSeconds) {
          const durationSeconds = endSeconds - startSeconds;
          clipDurationSpan.textContent = secondsToTimestamp(durationSeconds);
        } else {
          clipDurationSpan.textContent = '00:00';
        }
      } else {
        clipDurationSpan.textContent = 'è¨ˆç®—ä¸­...';
      }
    }

    // é è¦½å½±ç‰‡
    function togglePreview() {
      const videoUrl = videoUrlInput.value.trim();
      
      if (!validateYoutubeUrl()) {
        updateStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„ YouTube å½±ç‰‡ç¶²å€', 'error');
        return;
      }
      
      // å¾ç¶²å€ä¸­æå–å½±ç‰‡ID
      const videoIdMatch = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      if (!videoIdMatch) {
        updateStatus('ç„¡æ³•å¾ç¶²å€ä¸­ç²å–å½±ç‰‡ID', 'error');
        return;
      }
      
      const videoId = videoIdMatch[1];
      const startTime = validateTimeFormat(startTimeInput.value) ? timestampToSeconds(startTimeInput.value) : 0;
      
      if (videoPreview.style.display === 'none' || videoPreview.style.display === '') {
        // é¡¯ç¤ºé è¦½
        videoPreview.src = `https://www.youtube.com/embed/${videoId}?start=${startTime}&autoplay=1`;
        videoPreview.style.display = 'block';
        previewBtn.textContent = 'é—œé–‰é è¦½';
      } else {
        // éš±è—é è¦½
        videoPreview.src = '';
        videoPreview.style.display = 'none';
        previewBtn.textContent = 'é è¦½å½±ç‰‡';
      }
    }

    // è¼ªè©¢å·¥ä½œç‹€æ…‹
    function pollJobStatus(jobId) {
      if (jobPollingInterval) clearInterval(jobPollingInterval);
      
      jobPollingInterval = setInterval(async () => {
        try {
          const res = await fetch(`/check_status/${jobId}`);
          const data = await res.json();
          
          if (!res.ok) throw new Error(data.message || 'æŸ¥è©¢å¤±æ•—');
          
          // æ›´æ–°é€²åº¦æ¢
          if (data.progress) {
            processingProgress = parseFloat(data.progress);
            updateProgressBar(processingProgress);
          }
          
          updateStatus(data.message, data.status === 'processing' ? 'info'
                                                                : (data.status === 'completed' ? 'success' : 'error'));

          if (data.status !== 'processing') {
            clearInterval(jobPollingInterval);
            clearInterval(progressInterval);
            submitButton.disabled = false;

            if (data.status === 'completed' && data.filename) {
              // æ›´æ–°æ­·å²è¨˜éŒ„ç‹€æ…‹
              updateHistoryStatus(jobId, 'completed', data.filename);
              
              const link = document.createElement('a');
              link.href = `/download/${encodeURIComponent(data.filename)}`;
              link.textContent = `ä¸‹è¼‰åˆ‡å‰²å¾Œçš„å½±ç‰‡`;
              link.download = data.filename;
              link.style.display = 'inline-block';
              link.style.marginTop = '12px';
              link.className = 'download-link';
              statusMessageDiv.appendChild(link);
            } else if (data.status === 'failed') {
              updateHistoryStatus(jobId, 'failed');
            }
          }
        } catch (err) {
          updateStatus('è¼ªè©¢éŒ¯èª¤ï¼š' + err.message, 'error');
          clearInterval(jobPollingInterval);
          clearInterval(progressInterval);
          submitButton.disabled = false;
        }
      }, 4000);
    }

    // æ¨¡æ“¬é€²åº¦
    function startProgressSimulation() {
      processingProgress = 0;
      updateProgressBar(0);
      
      // æ·»åŠ é€²åº¦æ¢åˆ°ç‹€æ…‹æ¶ˆæ¯å€åŸŸ
      if (!document.querySelector('.progress-container')) {
        const progressContainer = document.createElement('div');
        progressContainer.className = 'progress-container';
        
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        progressBar.id = 'progressBar';
        
        progressContainer.appendChild(progressBar);
        statusMessageDiv.appendChild(progressContainer);
      }
      
      // æ¨¡æ“¬é€²åº¦å¢åŠ 
      progressInterval = setInterval(() => {
        if (processingProgress < 90) {
          // æ¨¡æ“¬éç·šæ€§é€²åº¦å¢åŠ  (é–‹å§‹å¿«ï¼Œå¾Œä¾†æ…¢)
          const increment = (90 - processingProgress) * 0.1;
          processingProgress += increment > 0.5 ? increment : 0.5;
          updateProgressBar(processingProgress);
        }
      }, 1000);
    }

    // æ›´æ–°é€²åº¦æ¢
    function updateProgressBar(percentage) {
      const progressBar = document.getElementById('progressBar');
      if (progressBar) {
        progressBar.style.width = `${Math.min(percentage, 100)}%`;
      }
    }

    // æ›´æ–°ç‹€æ…‹æ¶ˆæ¯
    function updateStatus(msg, type) {
      // ä¿ç•™ä¸‹è¼‰éˆæ¥
      const downloadLink = statusMessageDiv.querySelector('.download-link');
      
      statusMessageDiv.textContent = msg;
      statusMessageDiv.className = type || '';
      
      // å¦‚æœä¹‹å‰æœ‰é€²åº¦æ¢ï¼Œä¿ç•™å®ƒ
      if (document.querySelector('.progress-container')) {
        const progressContainer = document.querySelector('.progress-container');
        statusMessageDiv.appendChild(progressContainer);
      }
      
      // å¦‚æœä¹‹å‰æœ‰ä¸‹è¼‰éˆæ¥ï¼Œæ¢å¾©å®ƒ
      if (downloadLink) {
        statusMessageDiv.appendChild(downloadLink);
      }
      
      statusMessageDiv.style.animation = 'none';
      statusMessageDiv.offsetHeight; // è§¸ç™¼é‡ç¹ª
      statusMessageDiv.style.animation = 'fadeIn 0.3s ease';
    }

    // åˆ‡æ›æ·±è‰²æ¨¡å¼
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      
      // æ›´æ–°åœ–æ¨™
      darkModeToggle.innerHTML = isDarkMode ? 'â˜€ï¸ <span class="tooltiptext">åˆ‡æ›æ·ºè‰²æ¨¡å¼</span>' 
                                             : 'ğŸŒ™ <span class="tooltiptext">åˆ‡æ›æ·±è‰²æ¨¡å¼</span>';
    }

    // åŠ è¼‰æ·±è‰²æ¨¡å¼åå¥½
    function loadDarkModePreference() {
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        darkModeToggle.innerHTML = 'â˜€ï¸ <span class="tooltiptext">åˆ‡æ›æ·ºè‰²æ¨¡å¼</span>';
      }
    }

    // åˆ‡æ›æ­·å²é¢æ¿
    function toggleHistoryPanel() {
      historyPanel.classList.toggle('open');
      overlay.classList.toggle('visible');
    }

    // é—œé–‰æ­·å²é¢æ¿
    function closeHistoryPanel() {
      historyPanel.classList.remove('open');
      overlay.classList.remove('visible');
    }

    // æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
    function addToHistory(clipData, jobId) {
      const historyItem = {
        id: jobId,
        videoUrl: clipData.video_url,
        startTime: clipData.start_time,
        endTime: clipData.end_time,
        timestamp: new Date().toISOString(),
        status: 'processing',
        filename: null
      };
      
      history.unshift(historyItem);
      
      // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
      if (history.length > 20) {
        history = history.slice(0, 20);
      }
      
      saveHistory();
      renderHistory();
    }

    // æ›´æ–°æ­·å²è¨˜éŒ„ç‹€æ…‹
    function updateHistoryStatus(jobId, status, filename = null) {
      const itemIndex = history.findIndex(item => item.id === jobId);
      if (itemIndex !== -1) {
        history[itemIndex].status = status;
        if (filename) {
          history[itemIndex].filename = filename;
        }
        saveHistory();
        renderHistory();
      }
    }

    // ä¿å­˜æ­·å²è¨˜éŒ„
    function saveHistory() {
      localStorage.setItem('clipHistory', JSON.stringify(history));
    }

    // æ¸²æŸ“æ­·å²è¨˜éŒ„
    function renderHistory() {
      historyItems.innerHTML = '';
      
      if (history.length === 0) {
        historyItems.innerHTML = '<div class="history-empty">æš«ç„¡å‰ªè¼¯æ­·å²</div>';
        return;
      }
      
      history.forEach(item => {
        const videoIdMatch = item.videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        const videoId = videoIdMatch ? videoIdMatch[1] : '';
        
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        const date = new Date(item.timestamp);
        const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        let statusText = 'è™•ç†ä¸­';
        let statusClass = 'processing';
        
        if (item.status === 'completed') {
          statusText = 'å·²å®Œæˆ';
          statusClass = 'completed';
        } else if (item.status === 'failed') {
          statusText = 'è™•ç†å¤±æ•—';
          statusClass = 'failed';
        }
        
        historyItem.innerHTML = `
          <h3 title="${item.videoUrl}">YouTube ç‰‡æ®µ</h3>
          <div class="history-meta">
            <span>${item.startTime} - ${item.endTime}</span>
            <span class="status ${statusClass}">${statusText}</span>
          </div>
          <div class="history-meta">
            <span>${formattedDate}</span>
          </div>
          <div class="history-actions">
            <button class="history-btn load-btn" data-url="${item.videoUrl}" data-start="${item.startTime}" data-end="${item.endTime}">è¼‰å…¥è¨­å®š</button>
            ${item.status === 'completed' ? `<a href="/download/${encodeURIComponent(item.filename)}" class="history-btn download-btn" download="${item.filename}">ä¸‹è¼‰</a>` : ''}
          </div>
        `;
        
        historyItems.appendChild(historyItem);
        
        // æ·»åŠ è¼‰å…¥æŒ‰éˆ•äº‹ä»¶
        const loadBtn = historyItem.querySelector('.load-btn');
        loadBtn.addEventListener('click', function() {
          videoUrlInput.value = this.dataset.url;
          startTimeInput.value = this.dataset.start;
          endTimeInput.value = this.dataset.end;
          closeHistoryPanel();
          validateYoutubeUrl();
          updateClipDuration();
        });
      });
    }

    // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>